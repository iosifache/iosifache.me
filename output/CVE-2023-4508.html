<!DOCTYPE html>
<html
  lang="en"
  data-theme="light"
>
  <head>
     <title> @iosifache | CVE-2023-4508 </title>

    <meta charset="utf-8" />
    <meta name="generator" content="Pelican" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/@picocss/pico@1/css/pico.min.css"
    />
    <link rel="stylesheet" href="/theme/css/style.css" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Roboto+Slab:wght@100;300;400;500;700;800&display=swap"
      rel="stylesheet"
    />

    <link rel="icon" href="/theme/images/favicon.png" type="image/x-icon" />
           <meta name="tags" content="vulnerability-discovery" />
<meta name="tags" content="open-source" />
   </head>

  <body>
    <main class="container">
      <nav>
        <ul>
          <li>
            <strong>
              <a href="/"
                >@iosifache</a
              >
            </strong>
          </li>
        </ul>
        <ul>
          <li><a href="/">Articles</a></li>
          <li><a href="/oss">Open source</a></li>
          <li><a href="/talks">Talks</a></li>
          <li><a href="/podcasts">Podcasts</a></li>
          <li><a href="/about">About</a></li>
          <li><a href="/now">Now</a></li>
        </ul>
      </nav>
<h1 class="entry-title">
  <a
    href="/CVE-2023-4508.html"
    rel="bookmark"
    title="Permalink to CVE-2023-4508"
    >CVE-2023-4508</a
  >
</h1>
<div class="post-info">
  <b>Last updated</b>:
  <time class="published" datetime="2024-03-08T00:00:00+02:00">
    Fri 08 March 2024
  </time>
    <div class="tags">
    <b>Tags</b>:     <a href="/tag/vulnerability-discovery.html"
      ><small class="chip">vulnerability-discovery</small></a
    >
    <a href="/tag/open-source.html"
      ><small class="chip">open-source</small></a
    >
  </div>
</div>
<br /><br />
<h1>Summary</h1>
<p>A user able to control file input to Gerbv, between versions 2.4.0 and 2.10.0, can cause a crash and cause denial-of-service with a specially crafted Gerber RS-274X file.</p>
<h1>Root cause analysis</h1>
<p>The Gerber RS-274X format defines the <code>IF</code> command (<code>INCLUDE FILE</code>, for referencing an external file) in its <a class="external-links" href="https://www2.pv.infn.it/~servel/rc_images/gerber_rs274xrevd_e.pdf">User's Guide</a> (page 28). A valid line using this command respects the format below:</p>
<div class="highlight"><pre><span></span><code><span class="c">%IF&lt;filename&gt;.&lt;extension&gt;*%</span>
</code></pre></div>

<p>The implementation of this functionality leverages two utilities:
- A <code>gerb_file_t</code> structure wrapping up details about an opened file, such as the file descriptor, filename, and data to be read; and
- A <code>gerb_fopen</code> function (from <code>gerb_file.c</code>) that takes a filename and returns a (partially-initialized) <code>gerb_fopen</code> structure;</p>
<p>The relevant execution flow in the context of this issue is as follows:
1. A <code>gerbv_open_image</code> function (from <code>gerbv.c</code>) is initially called in <code>main.c</code> through a proxy function called <code>main_open_project_from_filename</code>.
2. The <code>gerbv_open_image</code> internally calls <code>gerb_fopen</code> and stores the filename as a structural member in <code>fd-&gt;filename = g_strdup(filename)</code>.
3. In a call to <code>gerber_is_rs274x_p</code>, the file is checked to respect the RS-274X format.
4. If it respects the format, <code>parse_gerb</code> is called.
5. <code>parse_gerb</code> calls <code>gerber_parse_file_segment</code>.
6. If any command having a <code>%</code> is detected, <code>parse_rs274x</code> is called.
7. If the command is detected to be <code>IF</code>, then the file is read with <code>gerb_fopen</code>.
8. <code>gerber_parse_file_segment</code> is called again, this time having as argument a filename stored inside the initially-read file.</p>
<p>The issue resides in the fact that, compared to the second step, the eighth one does not set the filename. When the latter is accessed in further processing, an invalid address is dereferenced, which results in a crash of the program.</p>
<p>A code path achieving this is when the included files contain an invalid M-code (for example, <code>M09*</code>). Usually, despite the invalid code, the execution should continue without processing the erroneous information, but Gerbv executes the following in its <code>parse_M_code</code>:</p>
<div class="highlight"><pre><span></span><code>gerbv_stats_printf(stats-&gt;error_list, GERBV_MESSAGE_ERROR, -1,
        _(&quot;Encountered unknown M%02d code at line %ld in file \&quot;%s\&quot;&quot;),
        op_int, *line_num_p, fd-&gt;filename);
</code></pre></div>

<p>As it can be observed, the <code>fd-&gt;filename</code> is accessed in a logging call, so the execution will crash instead of raising a warning and continuing. This will not happen if the random value found on heap and implicitly assigned to <code>fd-&gt;filename</code> is <code>NULL</code>. Most compilers have a check against this scenario, and will only print <code>(null)</code>.</p>
<h1>CWEs</h1>
<ul>
<li>CWE-824: Access of Uninitialized Pointer</li>
</ul>
<h1>Affected components and releases</h1>
<p>The functionality of processing <code>IF</code> commands was introduced in <code>a5b8484</code>, which corresponds to <code>v2.4.0</code>.</p>
<h1>Attack vector</h1>
<p>An attacker must control the content of the RS-274X file processed by Gerbv.</p>
<h1>Impact</h1>
<p>Gerbv can be crashed when processing files.</p>
<h1>CVSS v3.1 vector</h1>
<ul>
<li>Vector: <code>CVSS:3.1/AV:L/AC:L/PR:N/UI:R/S:U/C:N/I:N/A:H</code></li>
<li>Base score: 5.5</li>
</ul>
<h1>Steps to reproduce</h1>
<p>For reproducing this, Cisco's <code>parse_aperture_strtok.1.poc</code> from CVE-2021-40401 was used as the file provided as an input parameter. The content of <code>parse_aperture_strtok.2.poc</code> was replaced with <code>M09*</code>.</p>
<p>As the issue depends on the random value of the unitialized <code>fd-&gt;filename</code>, it was reproduced by launching <code>gdb</code>, setting a breakpoint on <code>gerb_fopen</code>, and setting <code>fd-&gt;filename</code> to the value <code>0x0101010101</code>. Gerbv will generate a crash as follows:</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>gdb<span class="w"> </span>./gerbv
<span class="o">[</span>...<span class="o">]</span>
<span class="o">(</span>gdb<span class="o">)</span><span class="w"> </span>c
Continuing.

Program<span class="w"> </span>received<span class="w"> </span>signal<span class="w"> </span>SIGSEGV,<span class="w"> </span>Segmentation<span class="w"> </span>fault.
0x0000fffff7376590<span class="w"> </span><span class="k">in</span><span class="w"> </span>??<span class="w"> </span><span class="o">()</span><span class="w"> </span>from<span class="w"> </span>/lib/aarch64-linux-gnu/libc.so.6
<span class="o">(</span>gdb<span class="o">)</span><span class="w"> </span>bt
<span class="c1">#0  0x0000fffff7376590 in  () at /lib/aarch64-linux-gnu/libc.so.6</span>
<span class="c1">#1  0x0000fffff734b848 in  () at /lib/aarch64-linux-gnu/libc.so.6</span>
<span class="c1">#2  0x0000fffff735cd78 in  () at /lib/aarch64-linux-gnu/libc.so.6</span>
<span class="c1">#3  0x0000fffff73cfa3c in __vasprintf_chk () at /lib/aarch64-linux-gnu/libc.so.6</span>
<span class="c1">#4  0x0000fffff7648064 in g_vasprintf () at /usr/lib/aarch64-linux-gnu/libglib-2.0.so.0</span>
<span class="c1">#5  0x0000fffff761da88 in g_strdup_vprintf () at /usr/lib/aarch64-linux-gnu/libglib-2.0.so.0</span>
<span class="c1">#6  0x0000fffff7fa3d04 in gerbv_stats_printf (list=0xaaaaaab2ab20, type=GERBV_MESSAGE_ERROR, layer=-1, text=0xfffff7fb5830 &quot;Encountered unknown M%02d code at line %ld in file \&quot;%s\&quot;&quot;) at gerb_stats.c:242</span>
<span class="c1">#7  0x0000fffff7fa7088 in parse_M_code (fd=0xaaaaaab2ced0, image=0xaaaaaab16fc0, line_num_p=0xffffffffe0f0) at gerber.c:1183</span>
<span class="c1">#8  0x0000fffff7fa487c in gerber_parse_file_segment</span>
<span class="w">    </span><span class="o">(</span><span class="nv">levelOfRecursion</span><span class="o">=</span><span class="m">2</span>,<span class="w"> </span><span class="nv">image</span><span class="o">=</span>0xaaaaaab16fc0,<span class="w"> </span><span class="nv">state</span><span class="o">=</span>0xaaaaaab16f60,<span class="w"> </span><span class="nv">curr_net</span><span class="o">=</span>0xaaaaaab2af60,<span class="w"> </span><span class="nv">stats</span><span class="o">=</span>0xaaaaaab2aa70,<span class="w"> </span><span class="nv">fd</span><span class="o">=</span>0xaaaaaab2ced0,<span class="w"> </span><span class="nv">directoryPath</span><span class="o">=</span>0xaaaaaab14a60<span class="w"> </span><span class="s2">&quot;/home/gerbv/triggers&quot;</span><span class="o">)</span>
<span class="w">    </span>at<span class="w"> </span>gerber.c:172
<span class="c1">#9  0x0000fffff7fa7f40 in parse_rs274x</span>
<span class="w">    </span><span class="o">(</span><span class="nv">levelOfRecursion</span><span class="o">=</span><span class="m">1</span>,<span class="w"> </span><span class="nv">fd</span><span class="o">=</span>0xaaaaaab149a0,<span class="w"> </span><span class="nv">image</span><span class="o">=</span>0xaaaaaab16fc0,<span class="w"> </span><span class="nv">state</span><span class="o">=</span>0xaaaaaab16f60,<span class="w"> </span><span class="nv">curr_net</span><span class="o">=</span>0xaaaaaab2af60,<span class="w"> </span><span class="nv">stats</span><span class="o">=</span>0xaaaaaab2aa70,<span class="w"> </span><span class="nv">directoryPath</span><span class="o">=</span>0xaaaaaab14a60<span class="w"> </span><span class="s2">&quot;/home/gerbv/triggers&quot;</span>,<span class="w"> </span><span class="nv">line_num_p</span><span class="o">=</span>0xffffffffe350<span class="o">)</span><span class="w"> </span>at<span class="w"> </span>gerber.c:1459
<span class="c1">#10 0x0000fffff7fa4bec in gerber_parse_file_segment</span>
<span class="w">    </span><span class="o">(</span><span class="nv">levelOfRecursion</span><span class="o">=</span><span class="m">1</span>,<span class="w"> </span><span class="nv">image</span><span class="o">=</span>0xaaaaaab16fc0,<span class="w"> </span><span class="nv">state</span><span class="o">=</span>0xaaaaaab16f60,<span class="w"> </span><span class="nv">curr_net</span><span class="o">=</span>0xaaaaaab2af60,<span class="w"> </span><span class="nv">stats</span><span class="o">=</span>0xaaaaaab2aa70,<span class="w"> </span><span class="nv">fd</span><span class="o">=</span>0xaaaaaab149a0,<span class="w"> </span><span class="nv">directoryPath</span><span class="o">=</span>0xaaaaaab14a60<span class="w"> </span><span class="s2">&quot;/home/gerbv/triggers&quot;</span><span class="o">)</span>
<span class="w">    </span>at<span class="w"> </span>gerber.c:245
<span class="c1">#11 0x0000fffff7fa60a8 in parse_gerb (fd=0xaaaaaab149a0, directoryPath=0xaaaaaab14a60 &quot;/home/gerbv/triggers&quot;) at gerber.c:770</span>
<span class="c1">#12 0x0000fffff7facca0 in gerbv_open_image</span>
<span class="w">    </span><span class="o">(</span><span class="nv">gerbvProject</span><span class="o">=</span>0xaaaaaab14940,<span class="w"> </span><span class="nv">filename</span><span class="o">=</span>0xffffffffed6e<span class="w"> </span><span class="s2">&quot;/home/gerbv/triggers/CVE-2021-40401.1.poc&quot;</span>,<span class="w"> </span><span class="nv">idx</span><span class="o">=</span><span class="m">0</span>,<span class="w"> </span><span class="nv">reload</span><span class="o">=</span><span class="m">0</span>,<span class="w"> </span><span class="nv">fattr</span><span class="o">=</span>0x0,<span class="w"> </span><span class="nv">n_fattr</span><span class="o">=</span><span class="m">0</span>,<span class="w"> </span><span class="nv">forceLoadFile</span><span class="o">=</span><span class="m">1</span><span class="o">)</span><span class="w"> </span>at<span class="w"> </span>gerbv.c:527
<span class="c1">#13 0x0000fffff7fabf44 in gerbv_open_layer_from_filename_with_color</span>
<span class="w">    </span><span class="o">(</span><span class="nv">gerbvProject</span><span class="o">=</span>0xaaaaaab14940,<span class="w"> </span><span class="nv">filename</span><span class="o">=</span>0xffffffffed6e<span class="w"> </span><span class="s2">&quot;/home/gerbv/triggers/CVE-2021-40401.1.poc&quot;</span>,<span class="w"> </span><span class="nv">red</span><span class="o">=</span><span class="m">29555</span>,<span class="w"> </span><span class="nv">green</span><span class="o">=</span><span class="m">29555</span>,<span class="w"> </span><span class="nv">blue</span><span class="o">=</span><span class="m">57054</span>,<span class="w"> </span><span class="nv">alpha</span><span class="o">=</span><span class="m">45489</span><span class="o">)</span><span class="w"> </span>at<span class="w"> </span>gerbv.c:249
<span class="c1">#14 0x0000aaaaaaacb334 in main (argc=6, argv=0xffffffffe8e8) at main.c:937</span>
</code></pre></div>

<h1>Patch</h1>
<h2>Recommended to the maintainers</h2>
<p>The filename can be attached to the <code>gerb_file_t</code> structure in <code>gerb_fopen</code> to avoid invalid dereferencing.</p>
<h2>Applied by the maintainers</h2>
<p>The vulnerability was patched in <a class="external-links" href="https://github.com/gerbv/gerbv/pull/192/commits/dfb5aac533a3f9e8ccd93ca217a753258cba4fe5">the commit <code>dfb5aa</code></a> by moving the filename allocation and deallocation into the <code>gerb_fopen</code> and <code>gerb_fclose</code> functions.</p>
<p>The patch was made available to the users in <a class="external-links" href="https://github.com/gerbv/gerbv/releases/tag/v2.10.0">the <code>2.10.0</code> release</a>.</p>     </main>
  </body>
</html>